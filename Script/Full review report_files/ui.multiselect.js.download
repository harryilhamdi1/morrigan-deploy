/*
 * jQuery UI Multiselect
 *
 * Authors:
 *  Michael Aufreiter (quasipartikel.at)
 *  Yanick Rochon (yanick.rochon[at]gmail[dot]com)
 * 
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 * 
 * http://www.quasipartikel.at/multiselect/
 *
 * 
 * Depends:
 *	ui.core.js
 *	ui.sortable.js
 *
 * Optional:
 * localization (http://plugins.jquery.com/project/localisation)
 * scrollTo (http://plugins.jquery.com/project/ScrollTo)
 * 
 * Todo:
 *  Make batch actions faster
 *  Implement dynamic insertion through remote calls
 */


(function($) {

$.widget("ui.listmultiselect", {
  options: {
		sortable: true,
		searchable: true,
		doubleClickable: true,
		animated: 'fast',
		show: 'slideDown',
		hide: 'slideUp',
		dividerLocation: 0.6,
		maxSelected: false,
		nodeComparator: function(node1,node2) {
			var text1 = node1.text(),
			    text2 = node2.text();
				return text1 === text2 ? 0 : (text1 < text2 ? -1 : 1);
		}
	},
	_create: function() {
			const that = this;

		this.element.hide();
		this.id = this.element.attr("id");
		this.container = $('<div class="ui-multiselect ui-helper-clearfix ui-widget"></div>').insertAfter(this.element);
		this.selectedContainer = $('<div class="selected"></div>').appendTo(this.container);
		this.availableContainer = $('<div class="available"></div>').appendTo(this.container);
		
			// Actions for selected and available containers
			this.selectedActions = $(
				`<div class="actions ui-widget-header ui-helper-clearfix">
            <span class="count">0 ${$.ui.listmultiselect.locale.itemsCount}</span>
            <a href="#" class="remove-all">${$.ui.listmultiselect.locale.removeAll}</a>
        </div>`
			).appendTo(this.selectedContainer);

			this.availableActions = $(
				`<div class="actions ui-widget-header ui-helper-clearfix">
            <input type="text" class="search empty ui-widget-content ui-corner-all" placeholder="Search..."/>
            ${(this.options.maxSelected === false) ? `<a href="#" class="add-all">${$.ui.listmultiselect.locale.addAll}</a>` : ''}
        </div>`
			).appendTo(this.availableContainer);

			// Selected and available lists
			this.selectedList = $('<ul class="selected connected-list"><li class="ui-helper-hidden-accessible"></li></ul>').appendTo(this.selectedContainer);
			this.availableList = $('<ul class="available connected-list"><li class="ui-helper-hidden-accessible"></li></ul>').appendTo(this.availableContainer);

			// Set dimensions
		this.container.width(this.element.width()+1);
		this.selectedContainer.width(Math.floor(this.element.width()*this.options.dividerLocation));
		this.availableContainer.width(Math.floor(this.element.width()*(1-this.options.dividerLocation)));
			this.selectedList.height(this.element.height() - this.selectedActions.height());
			this.availableList.height(this.element.height() - this.availableActions.height());

			// Initialize lists
		this._populateLists(this.element.find('option'));
		
			// Remove All
			this.container.find(".remove-all").on("click", function (e) {
				e.preventDefault();
				const options = that.element.find('option:selected');
				options.prop('selected', false);
				that._populateLists(that.element.find('option'));
					});
			
			// Add All
			this.container.find(".add-all").on("click", function (e) {
				e.preventDefault();
				const options = that.element.find('option').not(":selected").prop('selected', true);
				that._populateLists(that.element.find('option'));
			});
		
			// Search functionality
		if (this.options.searchable) {
			this._registerSearchEvents(this.availableContainer.find('input.search'));
		} else {
				this.availableContainer.find('input.search').hide();
		}
	},

	_populateLists: function(options) {
			const that = this;
			
			this.selectedList.empty().append('<li class="ui-helper-hidden-accessible"></li>');
			this.availableList.empty().append('<li class="ui-helper-hidden-accessible"></li>');
			
			options.each(function () {
				const option = $(this);
				const item = that._getOptionNode(option);
				if (option.is(':selected')) {
					that.selectedList.append(item);
		} else {
					that.availableList.append(item);
		}
			});
		
			this._updateCount();
	},
		
		_getOptionNode: function (option) {
			const that = this;
			const node = $(
				`<li class="ui-state-default ui-element" title="${option.text()}">
                    <span>${option.text()}</span>
                    <a href="#" class="action"><span class="ui-corner-all ui-icon"></span></a>
                </li>`
			);
		
			node.find("a.action").on("click", function (e) {
				e.preventDefault();
				if (option.is(':selected')) {
					option.prop('selected', false);
					that.availableList.append(node);
					// Re-enable all available options when deselecting
					that.availableList.children('.ui-element').removeClass('ui-state-disabled');
					that.availableList.find('a.action').css('pointer-events', 'auto');
		} else {
					option.prop('selected', true);
					that.selectedList.append(node);
		}
				
				// Check and disable available options if max limit reached
				if (that.options.maxSelected !== false) {
					const currentCount = that.selectedList.children('.ui-element').length;
					if (currentCount >= that.options.maxSelected) {
						that.availableList.children('.ui-element').addClass('ui-state-disabled');
						that.availableList.find('a.action').css('pointer-events', 'none');
					}
				}
				
			that._updateCount();
		});
		
			return node;
  				},

		_updateCount: function () {
			const count = this.selectedList.children('.ui-element').length;
			this.selectedContainer.find('.count').text(`${count} ${$.ui.listmultiselect.locale.itemsCount}`);
 	},

		_registerSearchEvents: function (input) {
			const that = this;
			input.on("keyup", function () {
				const searchTerm = $(this).val().toLowerCase();
				that.availableList.children("li").each(function () {
					const text = $(this).text().toLowerCase();
					$(this).toggle(text.indexOf(searchTerm) > -1);
				});
		});
	}
});
		
	// Localization
$.extend($.ui.listmultiselect, {
	locale: {
		addAll:'Add all',
		removeAll:'Remove all',
		itemsCount:'items selected'
	}
});


})(jQuery);
