// checker2.js
// Some javascript functions. Yay!
// (c) 2005-2007 by Checker Software Systems, LTD.
// (Yaron)

if (!String.prototype.padStart) {
    String.prototype.padStart = function padStart (targetLength, padString) {
        targetLength = targetLength >> 0; 
        padString = String ((typeof padString !== "undefined" ? padString : ' '));
        if (this.length > targetLength) {
            return String (this);
        }
        else {
            targetLength = targetLength-this.length;
            if (targetLength > padString.length) {
                padString += padString.repeat (targetLength / padString.length); 
            }
            return padString.slice (0, targetLength) + String (this);
        }
    };
}

if (!String.prototype.includes) {
    String.prototype.includes = function (str) {
        var returnValue = false;

        if (this.indexOf (str) !== -1) {
            returnValue = true;
        }

        return returnValue;
    }
}

if (!Array.prototype.includes) {
    Array.prototype.includes = function(searchElement /*, fromIndex*/ ) {
        'use strict';
        if (this == null) {
            throw new TypeError('Array.prototype.includes called on null or undefined');
        }

        var O = Object(this);
        var len = parseInt(O.length, 10) || 0;
        if (len === 0) {
            return false;
        }
        var n = parseInt(arguments[1], 10) || 0;
        var k;
        if (n >= 0) {
            k = n;
        } else {
            k = len + n;
            if (k < 0) {
                k = 0;
            }
        }
        var currentElement;
        while (k < len) {
            currentElement = O[k];
            if (searchElement === currentElement ||
                (searchElement !== searchElement && currentElement !== currentElement)) { // NaN !== NaN
                return true;
            }
            k++;
        }
        return false;
    };
}

function OpenPopupWin (url, name, params){          
    var w = window.open(url, name, params);
    //var w=window.open($url, 'kelev');
    w.focus();
}

function openInNewWindow(url){
    // Change "_blank" to something like "newWindow" to load all links in the same new window
    // This function is like <a href=url target=_blank>, or supposed to be.
    // taken from:
    // http://www.456bereastreet.com/archive/200605/using_javascript_instead_of_target_to_open_new_windows/
    var newWindow = window.open(url, '_blank');
    newWindow.focus();
    return false;
}

function DaysInMonth (Date, Year){
    // Retuns how many days there are in the month in year
    // needs year for the leap-year considerations.
    // Taken from: http://www.smartwebby.com/DHTML/date_validation.asp

}

// get today date
function getDateandTime(fieldDay, fieldMonth, fieldYear, fieldHour, fieldMin, fieldSec){ 
    getDate(fieldDay, fieldMonth, fieldYear);

    var today= new Date();                              
    //var hour=0; var min=0; var sec=0;
    var todayStr;

    var hour=today.getHours();
    var min=today.getMinutes();
    var sec=today.getSeconds();
    min=checkTime(min);
    sec=checkTime(sec);

    var minResult = min % 5;
    if (minResult != 0) min = (min - minResult); 

    var secResult = sec % 5;
    if (secResult != 0) sec = (sec - secResult);

    if (/msie/i.test (navigator.userAgent)) //only override IE
    {
        var hField = changeGetElementById(fieldHour);
        var mField = changeGetElementById(fieldMin);
        var sFiels = changeGetElementById(fieldSec);
    }
    else
    {
        var hField = document.getElementById(fieldHour);
        var mField = document.getElementById(fieldMin);
        var sFiels = document.getElementById(fieldSec);
    }

    hField.selectedIndex=hour;    

    for (var im=0;im<mField.options.length;im++) { 
        if (mField.options[im].text == min) { 
            mField.selectedIndex = im; 
            break; 
        } 
    }  

    for (var is=0;is<sFiels.options.length;is++) { 
        if (sFiels.options[is].text == sec) { 
            sFiels.selectedIndex = is; 
            break; 
        } 
    }       
}

function checkTime(i){
    if (i<10){
        i="0" + i;
    }
    return i;
}

function changeGetElementById(id){
    if (/msie/i.test (navigator.userAgent)) //only override IE
    {
        document.nativeGetElementById = document.getElementById;
        //document.getElementById = function(id)
        {
            var elem = document.nativeGetElementById(id);
            if(elem)
            {
                //make sure that it is a valid match on id
                if(elem.attributes['id'].value == id)
                { 
                    return elem;
                }
                else
                {
                    //otherwise find the correct element
                    for(var i=1;i<document.all[id].length;i++)
                    {
                        if(document.all[id][i].attributes['id'].value == id)
                        { 
                            return document.all[id][i];
                        }
                    }
                }
            }  
            return null;
        };
    } 
}

function getDate(fieldDay, fieldMonth, fieldYear){ 
    var today= new Date();                              
    var todayStr;
    var day= today.getDate();
    var month= today.getMonth()+1;
    var year= today.getFullYear();

    d=$('#'+fieldDay);
    m=$('#'+fieldMonth);
    y=$('#'+fieldYear);
    
    for (var ida=0;ida<d[0].options.length;ida++) { 
        if ($('option:eq('+ida+')',d).text() == day) { 
            $('option:eq('+ida+')',d).prop('selected',true);
            break; 
        }
    }      

    for (var i=0;i<m[0].options.length;i++) { 
        if ($('option:eq('+i+')',m).text() == month) { 
            $('option:eq('+i+')',m).prop('selected',true);
            break; 
        } 
    }  

    for (var index=0;index<y[0].options.length;index++) { 
        if ($('option:eq('+index+')',y).text() == year) { 
            $('option:eq('+index+')',y).prop('selected',true);
            break; 
        } 
    }  
}

//Set focus to field ID and scroll to this field
function SetFocusandSelect(fieldID){   
    var field = document.getElementById(fieldID);
    field.focus();
    field.select;
    field.scrollIntoView();     
}  

function DateYearOrMonthChangeEvent (BaseFieldName){
    // Each time someone changes the year or the month,
    // we should calculate how many days we have in that month.
} 


function CheckRadioButton (id){
    // Simply marks the radio button whose id was specified. 
    // Currently in the combination of HandleDateRangesForReportForm and DateInputField
    if(!$('#'+id).is(':checked')){
    $('#'+id).prop('checked',true).click();
}
}

// Function to manage radioAnswersChecked class for radio buttons
function manageRadioAnswersCheckedClass() {
    var $ = (typeof jQuery !== 'undefined') ? jQuery : (typeof window.$ !== 'undefined') ? window.$ : null;
    if (!$) {
        setTimeout(manageRadioAnswersCheckedClass, 100);
        return;
    }
    
    $(document).on('change', 'input.SpepeateRadio[type="radio"]', function() {
        var $radio = $(this);
        if (!$radio.is(':checked')) return;
        
        var fieldName = $radio.attr('name');
        var radioId = $radio.attr('id');
        if (!fieldName || !radioId) return;
        
        // Remove class from all spans with same field name
        $('span[name="' + fieldName + '"]').removeClass('radioAnswersChecked');
        
        // Add class to the span containing this radio
        var $span = $radio.closest('span.radioAnswers');
        ($span.length ? $span : $('#ansspn' + radioId)).addClass('radioAnswersChecked');
    });
}

// Initialize when jQuery is available
(function init() {
    if (typeof jQuery !== 'undefined' || typeof window.$ !== 'undefined') {
        if (typeof addLoadEvent !== 'undefined') {
            addLoadEvent(manageRadioAnswersCheckedClass);
        } else {
            var $ = (typeof jQuery !== 'undefined') ? jQuery : window.$;
            $(manageRadioAnswersCheckedClass);
        }
    } else {
        setTimeout(init, 50);
    }
})();

function askForEmailAddressAndSubmit(form, promptText, destinationField, promptForMessage, messageField)
// Uses the js prompt() function to ask for an email address. If one specified, then sets the given destination field in the form, and 
// submits the form.
// Used in TableReport, inside function tr_PrintExportOrEmailButton_OrPerformExport()
{
    var theEmail;
    var theMessage;
    theEmail = prompt(promptText);  
    if(Echeck(theEmail))
    {
        theMessage = prompt(promptForMessage);
        if (theEmail)
        {
            form.elements[destinationField].value = theEmail;
            if (theMessage) 
            { 
                form.elements[messageField].value = theMessage;
            }
            return true; 
        }
    }
    else return false;       
} 

//email validation
function Echeck(str){
    var at="@"
    var dot="."
    var lat=str.indexOf(at)
    var lstr=str.length
    var ldot=str.indexOf(dot)
    if (str.indexOf(at)==-1){
        alert("Invalid E-mail ID")
        return false
    }

    if (str.indexOf(at)==-1 || str.indexOf(at)==0 || str.indexOf(at)==lstr){
        alert("Invalid E-mail")
        return false
    }

    if (str.indexOf(dot)==-1 || str.indexOf(dot)==0 || str.indexOf(dot)==lstr){
        alert("Invalid E-mail")
        return false
    }

    if (str.indexOf(at,(lat+1))!=-1){
        alert("Invalid E-mail")
        return false
    }

    if (str.substring(lat-1,lat)==dot || str.substring(lat+1,lat+2)==dot){
        alert("Invalid E-mail")
        return false
    }

    if (str.indexOf(dot,(lat+2))==-1){
        alert("Invalid E-mail")
        return false
    }

    if (str.indexOf(" ")!=-1){
        alert("Invalid E-mail")
        return false
    }

    return true          
}

//set value in textbox and removing value from combobox
function setCombobox(comboField,textFiled,imgFiled,totalTextBox,dataID,hiddenTextFiled){    
    var tNew_sel=new Array();
    var counter=0;           
    if(parseInt(totalTextBox) >parseInt(document.getElementById('hidd'+dataID).value))
    {
        for(i=0;i<document.getElementById(comboField).length;i++)
        {   

            if(document.getElementById(comboField).options[i].selected==true)
            {                                           
                //setting combobox selected value into textbox
                curr_textFiled=textFiled+'_'+document.getElementById('hidd'+dataID).value;
                curr_imgFiled=imgFiled+'_'+document.getElementById('hidd'+dataID).value;
                curr_hiddenTextFiled=hiddenTextFiled+'_'+document.getElementById('hidd'+dataID).value;                                      
                document.getElementById(curr_textFiled).value=document.getElementById(comboField).options[i].text;                                               
                document.getElementById(curr_hiddenTextFiled).value=document.getElementById(comboField).options[i].value;
                //               if(document.getElementById(comboField).options[i].value == -3){
                //                 SelectedText = document.getElementById(comboField).options[i].text;  
                //                 SelectedValue = document.getElementById(comboField).options[i].value;  
                //                 BlockForIrrelevantOption(comboField, textFiled, imgFiled, totalTextBox, dataID, hiddenTextFiled, SelectedText, SelectedValue);
                //                 break; 
                //              }

                for(k=0;k<document.getElementById('hidd'+dataID).value;k++)
                {                  
                    prevImgFiled=imgFiled+'_'+k;                    
                    document.getElementById(prevImgFiled).style.display='none';
                }                  
                //show hide image icons 
                document.getElementById(curr_imgFiled).style.display='';                  
                document.getElementById('hidd'+dataID).value=parseInt(document.getElementById('hidd'+dataID).value)+parseInt(1);           
            }
            else
            {
                //remaining combobox value stored into variable
                tNew_sel[counter]=new Array();
                tNew_sel[counter]['text'] = document.getElementById(comboField).options[i].text;
                tNew_sel[counter]['value'] =document.getElementById(comboField).options[i].value;             
                counter++;
            }
        }
    }  
    //Resetting combobox value
    //alert(document.getElementById(comboField).length);          
    if(counter != 0)
    {              
        document.getElementById(comboField).length=0;
        for(j=0;j<counter;j++)
        {
            document.getElementById(comboField).options[j] = new Option(tNew_sel[j]['text'],tNew_sel[j]['value']);


        }
    }
    else if(counter == 0 && document.getElementById(comboField).length==1)
    {
        document.getElementById(comboField).length=0; 
    }         
}   

//remove value from textbox and add value in combobox
function deleteFromTextBox(comboField,textFiled,imgFiled,totalTextBox,dataID,hiddenTextFiled){     
    //setting value into textbox    
    varHidden=parseInt(document.getElementById('hidd'+dataID).value)-1;
    curr_textFiled=textFiled+'_'+varHidden;
    curr_imgFiled=imgFiled+'_'+varHidden;
    //active last texbox image
    if(parseInt(varHidden)>0)
        prev_imgFiled=imgFiled+'_'+(varHidden-1);  

    curr_hiddenTextFiled=hiddenTextFiled+'_'+varHidden;                    

    //remove textbox value and setting into combobox
    document.getElementById(comboField).length=parseInt(document.getElementById(comboField).length)+1;         
    document.getElementById(comboField).options[parseInt(document.getElementById(comboField).length)-1] = new Option(document.getElementById(curr_textFiled).value,document.getElementById(curr_hiddenTextFiled).value);        
    document.getElementById('hidd'+dataID).value=parseInt(document.getElementById('hidd'+dataID).value)-1;
    document.getElementById(curr_textFiled).value='';
    document.getElementById(curr_hiddenTextFiled).value='';

    document.getElementById(curr_imgFiled).style.display='none';
    if(parseInt(varHidden)>0)  
        document.getElementById(prev_imgFiled).style.display='block';
}

function HideMe(field){
    $("#" + field).hide();
    //    document.getElementById(field).style.display="none";
}

function ShowMe(field){
    $("#" + field).show();
    //    document.getElementById(field).style.display="block";
}

function HideMeName(fieldName){
    document.getElementsByName(fieldName).style.display="none";
}
function ShowMeName(fieldName){
    document.getElementsByName(fieldName).style.display="block";
}

function ClearMe(field){
    // Commented out since did not affect DOM
    //$('#'+field).val('');
    $('#'+field).attr('value', '');
    $('#'+field).html('');
}

function showHideText(fieldNamecntr ,fieldName,total){              
    fieldNamecntr='id'+fieldNamecntr;
    for(i=0;i<total;i++)
    {                    
        curr='id'+fieldName+''+i;                 
        if(curr==fieldNamecntr)                      
            document.getElementById('id'+fieldName+i).style.display='block';                    
        else
            document.getElementById('id'+fieldName+i).style.display='none';                      
    }              
}


function LimitAttach(form, file, extArray) {
    //extArray = new Array("gif", "jpg", "png"); 
    allowSubmit = false;
    if (!file) return;
    while (file.indexOf("\\") != -1)
        file = file.slice(file.indexOf("\\") + 1);
    ext = file.slice(file.indexOf(".") + 1).toLowerCase(); 
    for (var i = 0; i < extArray.length; i++) {
        if (extArray[i] == ext) { allowSubmit = true; break; }
    }
    if (allowSubmit) 
        form.submit();
    else
    {
        alert("Please only upload files that end in types:  " 
            + (extArray.join("  ")) + "\nPlease select a new "
            + "file to upload and submit again.");
        return false;
    }
}

function promptCallback(val, form) {
    if(Echeck(val))
    {   
        if (val)                              
        { 
            $('#'+form+' #destinationEmailAddress').val(val);

            document.getElementById(form).submit(); 
        }
    }
    else return false;   
}

function submit_preset_form_button() {
    if (typeof(preset_button_to_submit) !== 'undefined' && preset_button_to_submit){                                      
        $('input#'+preset_button_to_submit).click();
    }
}

///////////////////////////////////////////////////////////
// Usage IEprompt("dialog descriptive text", "default starting value");
// 
// IEprompt will call promptCallback(val)
// Where val is the user's input or null if the dialog was canceled.
///////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////
// This source code has been released into the public domain
// January 14th, 2007.
// You may use it and modify it freely without compensation
// and without the need to tell everyone where you got it.
///////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////
// You must create a promptCallback(val) function to handle
// the user input.  If you don't this script will fail and
// Bunnies will die.
///////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////
// These are global scope variables, they should remain global.
///////////////////////////////////////////////////////////
var _dialogPromptID=null;
var _blackoutPromptID=null;
///////////////////////////////////////////////////////////

function IEprompt(innertxt, form, def) {

    that=this;

    // Check to see if this is MSIE 7.   This isn't a great general purpose
    // detection system but it works well enough just to find MSIE 7.
    var _isIE7=(navigator.userAgent.indexOf('MSIE 7')>0);

    this.wrapupPrompt = function (cancled) {
        // wrapupPrompt is called when the user enters or cancels the box.
        // It's called only by the IE7 dialog box, not the non IE prompt box
        if (_isIE7) {
            // Make sure we're in IE7 mode and get the text box value
            val=document.getElementById('iepromptfield').value;
            // clear out the dialog box
            _dialogPromptID.style.display='none';
            // clear out the screen
            _blackoutPromptID.style.display='none';
            // clear out the text field
            document.getElementById('iepromptfield').value = '';
            // if the cancel button was pushed, force value to null.
            if (cancled) { val = '' }
            // call the user's function
            promptCallback(val, form);
        }
        return false;
    }

    //if def wasn't actually passed, initialize it to null
    if (def==undefined) { def=''; }

    if (_isIE7) {
        // If this is MSIE 7.0 then...
        if (_dialogPromptID==null) {
            // Check to see if we've created the dialog divisions.
            // This block sets up the divisons
            // Get the body tag in the dom
            var tbody = document.getElementsByTagName("body")[0];
            // create a new division
            tnode = document.createElement('div');
            // name it
            tnode.id='IEPromptBox';
            // attach the new division to the body tag
            tbody.appendChild(tnode);
            // and save the element reference in a global variable
            _dialogPromptID=document.getElementById('IEPromptBox');
            // Create a new division (blackout)
            tnode = document.createElement('div');
            // name it.
            tnode.id='promptBlackout';
            // attach it to body.
            tbody.appendChild(tnode);
            // And get the element reference
            _blackoutPromptID=document.getElementById('promptBlackout');
            // assign the styles to the blackout division.
            _blackoutPromptID.style.opacity='.9';
            _blackoutPromptID.style.position='absolute';
            _blackoutPromptID.style.top='0px';
            _blackoutPromptID.style.left='0px';
            _blackoutPromptID.style.backgroundColor='#555555';
            _blackoutPromptID.style.filter='alpha(opacity=90)';
            _blackoutPromptID.style.height=(document.body.offsetHeight<screen.height) ? screen.height+'px' : document.body.offsetHeight+20+'px'; 
            _blackoutPromptID.style.display='block';
            _blackoutPromptID.style.zIndex='50';
            // assign the styles to the dialog box
            _dialogPromptID.style.border='2px solid blue';
            _dialogPromptID.style.backgroundColor='#DDDDDD';
            _dialogPromptID.style.position='absolute';
            _dialogPromptID.style.width='330px';
            _dialogPromptID.style.zIndex='100';
        }
        // This is the HTML which makes up the dialog box, it will be inserted into
        // innerHTML later. We insert into a temporary variable because
        // it's very, very slow doing multiple innerHTML injections, it's much
        // more efficient to use a variable and then do one LARGE injection.
        var tmp = '<div style="width: 100%; background-color: blue; color: white; font-family: verdana; font-size: 10pt; font-weight: bold; height: 20px">Input Required</div>';
        tmp += '<div style="padding: 10px">'+innertxt + '<BR><BR>';
        tmp += '<form action="" onsubmit="return that.wrapupPrompt()">';
        tmp += '<input id="iepromptfield" name="iepromptdata" type=text size=46 value="'+def+'">';
        tmp += '<br><br><center>';
        tmp += '<input type="submit" value="&nbsp;&nbsp;&nbsp;OK&nbsp;&nbsp;&nbsp;">';
        tmp += '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
        tmp += '<input type="button" onclick="that.wrapupPrompt(true)" value="&nbsp;Cancel&nbsp;">';
        tmp += '</form></div>';
        // Stretch the blackout division to fill the entire document
        // and make it visible.  Because it has a high z-index it should
        // make all other elements on the page unclickable.
        _blackoutPromptID.style.height=(document.body.offsetHeight<screen.height) ? screen.height+'px' : document.body.offsetHeight+20+'px'; 
        _blackoutPromptID.style.width='100%';
        _blackoutPromptID.style.display='block';
        // Insert the tmp HTML string into the dialog box.
        // Then position the dialog box on the screen and make it visible.
        _dialogPromptID.innerHTML=tmp;
        _dialogPromptID.style.top=parseInt(document.documentElement.scrollTop+(screen.height/3))+'px';
        _dialogPromptID.style.left=parseInt((document.body.offsetWidth-315)/2)+'px';
        _dialogPromptID.style.display='block';
        // Give the dialog box's input field the focus.
        document.getElementById('iepromptfield').focus();
    } else {
        // we are not using IE7 so do things "normally"
        promptCallback(prompt(innertxt, def), form);
    }
}

function toggleButton (button, text) {
    // Make button disables when clicked so users wont click it twice
    button.value=text;
    //if (typeof button.disabled != "undefined")
    //    button.disabled = !button.disabled;
    //  else if (button.clicked) {
    //    button.clicked = false;
    //    button.value = button.oldValue;
    //  }
    //  else {
    //    button.clicked = true;
    //    button.oldValue = button.value;
    //    button.value = 'DISABLED';
    //  }
}

function togglelinks (postid) {
    // Will make links show 'ok' instead of the original text
    //var whichpost = document.getElementById(postid);
    var whichpost = postid;
    //whichpost.removeAttribute("href");
    //whichpost.style.display='none';
    whichpost.innerHTML='please wait';
    return true;
}

function show_confirm(text, msg1, msg2){   
    var r=confirm(text);
    if (r)
        return true;
    else
        return false;

}

// bitamar 2010-06-07 - commenting out the copies of checkUncheckAll from many files and putting one here  
var checkflag = "false";
function checkUncheckAll(tableId, checkboxName, selectTranslation, unselectTranslation, noFilters){
    var ret;
    noFilters = "false"; // AZam 31-10-2017 Doing this so that It work fro all reports, instead of make changes in all reports 
    if (checkflag == "false") // bitamar 2010-06-07 - on select all, ignore filtered options
    {
        $("#" + tableId + " tbody tr:visible").each(function(){            
                    $(this).find("input[name='"+checkboxName+"']").prop("checked", true);
        });
        checkflag = "true";
        return unselectTranslation;
    }
    else // bitamar 2010-06-07 - on unselect all, uselect all
    {      
        $("#" + tableId + " tbody tr:visible").each(function () {
                $(this).find("input[name='" + checkboxName + "']").prop("checked", false);
        });
        checkflag = "false";
        return selectTranslation;
    }
}

var checkflag = "false";
function checkUncheckAllComments(button,tableId, checkboxName, selectTranslation, unselectTranslation, noFilters) {
    checkflag = $(button).data('checkflag') || "false";
    noFilters = "false"; // AZam 31-10-2017 Doing this so that It work fro all reports, instead of make changes in all reports 
    if (checkflag == "false") // bitamar 2010-06-07 - on select all, ignore filtered options
    {
        $("#" + tableId + " tbody tr:visible").each(function () {
            $(this).find("input[name='" + checkboxName + "']").prop("checked", true);
        });
        $(button).data('checkflag', true);
        return unselectTranslation;
    }
    else // bitamar 2010-06-07 - on unselect all, uselect all
    {
        $("#" + tableId + " tbody tr:visible").each(function () {
            $(this).find("input[name='" + checkboxName + "']").prop("checked", false);
        });
        $(button).data('checkflag', false);

        return selectTranslation;
    }
}


function toggle(id){
    $('#' + id).toggle();
}

function toggleslide(id){
    $('#' + id).slideToggle( "slow" );
}

function check_if_value_selected(fieldNameToCheck, valueToFind){
    var elLength = 0;
    var fieldToCheck = null;

    if (document.getElementById(fieldNameToCheck)) {
        fieldToCheck = document.getElementById(fieldNameToCheck);
    }
    else if (fieldNameToCheck) {
        fieldToCheck = fieldNameToCheck;
    }
    else {
        return false;
    }

    elLength = fieldToCheck.length;

    if (fieldToCheck.value==valueToFind) {
        return true;
    }
    else if (elLength > 0)
    {
        for (i=0; i<elLength; i++) {
            if (fieldToCheck && fieldToCheck.options && fieldToCheck.options[i].value==valueToFind && fieldToCheck.options[i].selected==true){
                return true;
            }
        }
    }
    return false;
}

function retrive_selected_value(fieldNameToCheck){
    if (document.getElementById(fieldNameToCheck)){
        return document.getElementById(fieldNameToCheck).value;
    }else{
        return null;
    }
}

function ShowHideOtherAddition(fieldNameToCheck, valueToFind, fieldNameToShowHide){
    if (document.getElementById(fieldNameToShowHide)){
        if (check_if_value_selected(fieldNameToCheck, valueToFind)){
            document.getElementById(fieldNameToShowHide).style.display="block";
        }else{
            document.getElementById(fieldNameToShowHide).style.display="none";
        }
    }
}

function CreateXmlHttpObject() { //fuction to return the xml http object
    var xmlhttp=false;    
    try{
        xmlhttp=new XMLHttpRequest();//creates a new ajax object
    }
    catch(e)    {        
        try{            
            xmlhttp= new ActiveXObject("Microsoft.XMLHTTP");//this is for IE browser
        }
        catch(e){
            try{
                req = new ActiveXObject("Msxml2.XMLHTTP");//this is for IE browser
            }
            catch(e1){
                xmlhttp=false;//error creating object
            }
        }
    }
    return xmlhttp;
}

function updateFieldFromURL(strURL, ddToUpdate, ddToClear){
    var req = CreateXmlHttpObject(); // fuction to get xmlhttp object
    if (req){
        req.onreadystatechange = function(){
            if (req.readyState == 4) { //data is retrieved from server
                if (req.status == 200) { // which represents ok status                    
                    document.getElementById(ddToUpdate).innerHTML=req.responseText;//put the results of the requests in or element

                    if (ddToClear) {
                        document.getElementById(ddToClear).innerHTML = "";
                    }
                }
                else {
                    alert("There was a problem while using XMLHTTP:\n");
                }
            }
        }
        req.open("GET", strURL, true); //open url using get method
        req.send(null);//send the results
    }
}

function open_export_type_dialogue(form_name,width,height){
    $("#exportSPAN"+form_name).dialog();
    $("#exportSPAN"+form_name).dialog( "option", "modal", true);
    if(width>0){
        $("#exportSPAN"+form_name).dialog( "option", "width", width);
    }
    if(height>0){
        $("#exportSPAN"+form_name).dialog( "option", "height", height);
    }
    $("#exportSPAN"+form_name).dialog( "open");
}

/**
     * Init the export dialog box
     */
function initExportDialog(id) {
    let selectedItems = $('#orders_list'+id+' input[name="selected_orders[]"]:checked');

    $('#export-format'+id).hide();

    if (selectedItems.length === 0) {
        $('#columns' + id).hide();
        $('#selectItemsError' + id).show();
    } else {
        $('#columns' + id).show();
        $('#selectItemsError' + id).hide();
    }
}


/**
     * Export review comments to file with selected format
     */
function exportReviewComments(id) {
    let comments = $('#exportSPANComments'+id+' input[name="comment_type"]:checked').val();
    let exportType = $('#exportSPANComments' + id +' select[name="export_type"]').val();
    let selectedItems = $('#orders_list' + id +' input[name="selected_orders[]"]:checked');

    if (selectedItems.length === 0) return;

    let items = [];
    for (let i = 0; i < selectedItems.length; ++i) items.push(selectedItems[i].value);

    $('#export-format'+id).hide();
    $("#ajax-loading"+id).show();
    

    $.ajax({
        type: "POST",
        url: "index.php?Controller=ClientReviewsStatusManagement&Action=Export",
        data: { comment_type: comments, export_type: exportType, items: items },

    })
        .done(function (json) {
            $('#exportDownloadLink' + id).html(json);
            $("#ajax-loading" + id).hide();
            $('#exportSPANComments' + id).dialog("close");
        })
        .fail(function () {
            $("#ajax-loading" + id).hide();
        });
}


function addLoadEvent(func) {
    $(function(){
        func();
    });
}

function open_dialog(div_id){
    $( "#"+div_id ).dialog({
        autoOpen: false,
        width: 500,
        show: {
            effect: "puff",
            duration: 1000
        },
        hide: {
            effect: "puff",
            duration: 1000
        }
    });

    $("#"+div_id).dialog("open");
}

function process_excel_export(datavarname){
    var data=$('#'+datavarname).val();
    var form = $('<form action="export-to-excel.php" method="post">' +
        '<input type="hidden" name="xls_export_array" value='+data+' />' +
        '</form>');
    $('body').append(form);
    $(form).submit();
}

if (typeof answerRank == 'undefined') {
    var answerRank = {};
}

var sd_upd_ranking = function (id, value) {
    
    answerRank [id] ||= [];
    
    if (!answerRank [id].includes (value)) {
         answerRank [id].push (value);
    } else {
         answerRank [id] = answerRank [id].filter (
             e => e != value
         );
    }

    sd_display_ranking ();

    $ ('form[name="crit_form"]').append (
        $ ('<input class="rnk-result" type="hidden">')
            .attr ('value' , JSON.stringify (answerRank))
            .attr ('name'  , 'rnk-result')
    );
}

var sd_display_ranking = function () {
    $ (".checkboxAnswers label span, .rnknum, .rnk-result").remove ();
    
    for (const [inputId, optionIds] of Object.entries (answerRank))  {
        let rank = 1; 
        for (let i = 0; i < optionIds.length; i++)  {
            $ (`input[name="${inputId}[]"][value="${optionIds [i]}"]`).parent ().append (
               `<div class="rnknum">${rank++}</div>`
            );
        }
    }
}

function activateimage_rotate(direction,attachID,uniq){
    $('img#image_rotate_'+direction+'_'+attachID+'_'+uniq).click(function(){
        $.get('file-attach-image-rotate.php',{AttachID: attachID,direction: direction, entity: 'Crit'}).done(
            function(data){
                if(data=='done'){
                    // if it was successful - reload image
                    $('img#image'+attachID).attr('src', $('img#image'+attachID).attr('src')+'?'+Math.random());
                }else{
                    //alert('Image could not be rotated '+data);
                }
            }
        )
    });
}

function activate_file_delete(attachID,critID,uniq){
    $('.image_delete_'+attachID+'_'+uniq).click(function(){
        
        $( '<div>Are you sure you want to delete this file?</div>' ).dialog({
            resizable: false,
            modal: true,
            position: { my: "center", at: "center", of: event.target },
            buttons: {
                "Delete this file": function() {
                    $.get('file-attach-delete.php',{AttachID: attachID, CritID: critID}).done(
                        function(data){
                            if(data=='done'){
                                // if it was successful - reload image
                                $('img#image_delete_'+attachID).parent().html("File Deleted");
                                $('img#image'+attachID).parent().html("File Deleted");
                            }else{
                                //alert('File could not be deleted '+data);
                            }
                        }
                    );
                    $( this ).dialog( "close" );
                },
                Cancel: function() {
                    $( this ).dialog( "close" );
                }
            }
        });
    });
}


function open_exportall_operation_type_dialogue(e, t, n) {
    $("#exportallSPAN" + e).dialog(), $("#exportallSPAN" + e).dialog("option", "modal", !0), t > 0 && $("#exportallSPAN" + e).dialog("option", "width", t), n > 0 && $("#exportallSPAN" + e).dialog("option", "height", n), $("#exportallSPAN" + e).dialog("open")
}

var _dialogPromptID = null,
_blackoutPromptID = null,
checkflag = "false";

var geo_variable_x = "";
function getLocation(placeindiv){
    geo_variable_x=document.getElementById(placeindiv);
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
    } else {
        //x.innerHTML = "Geolocation is not supported by this browser.";
    }
}
function showPosition(position) {
    geo_variable_x.value = position.coords.latitude + 
    "," + position.coords.longitude; 
}

function insertDrillDownCols(urlToFetch,insertAfterColID,tableName,skip_columns){
    // remove filters as it was breaking the html
    $('tr.filters').remove();
    // put loading sing
    $('a#'+insertAfterColID).after('<img src="images/loader.svg" id="img'+insertAfterColID+'">');
    $('a#'+insertAfterColID).hide();

    $.get(urlToFetch).done(function( data ) {
        // look for table start
        var table_n = data.search(tableName);
        // remove everything before it
        data = data.substr(table_n-1);
        // look for first tabody
        var tb_n = data.search('<thead');
        // remove everything before it
        data = data.substr(tb_n+6);
        // look for table end
        var tableend_n = data.search('</table>');
        // remove everything after it
        data= data.substr(1,tableend_n+7);
        var dataobj = {s:data};

        insertDD_processTable(true, 0,tableName,skip_columns,insertAfterColID,dataobj);
        insertDD_processTable(false,0,tableName,skip_columns,insertAfterColID,dataobj);
        insertDD_processTable(false, 1,tableName,skip_columns,insertAfterColID,dataobj);

        $('#img'+insertAfterColID).hide();
    });
}

function insertDD_processTable(thead,childnum,tableName,skip_columns,insertAfterColID,data){
    var elem='th';
    var line_index=-1;
    var col_index=$('a#'+insertAfterColID).parent(elem).index();
    do{
        var range_max=data.s.search((thead==true) ? '</thead>' : '</tbody>');
        line_index++;
        // find  first line
        var line_start=data.s.search('<'+elem);
        if(line_start<0 && elem=='th'){
            elem='td';
            line_start=data.s.search('<'+elem);
        }
        if(line_start>=0 && line_start<range_max){
            data.s=data.s.substr(line_start);
            var line_end=data.s.search('</tr>');
            var line=data.s.substr(0,line_end);
            //find how many columns we are about to add
            var columns_to_add=(line.match(new RegExp('<'+elem, 'g')) || []).length-skip_columns;

            // remove this line from the general table data storage so it wont be processed twice
            data.s=data.s.substr(line_end);

            // remove first few cells
            var line_id='';
            for(var i=1;i<=skip_columns;i++){
                var cell_end=line.search('</'+elem+'>')+5;
                if(i==1){
                    var cell_start=line.search('>')+1;
                    line_id=line.substr(cell_start,cell_end-cell_start-5);
                    //alert(line_id);
                } 
                line=line.substr(cell_end);
            }
            // now we have the section to add.
            if(thead!=true){
                // check if this is the correct line identifier
                while($('#'+tableName).children((thead==true) ? 'thead' : 'tbody').eq(childnum).children('tr').eq(line_index).children(elem).eq(0).html()!=line_id && line_index<300 && line_start<range_max){
                    //alert(line_index+':'+$('#'+tableName).children((thead==true) ? 'thead' : 'tbody').children('tr').eq(line_index).children(elem).eq(0).html());
                    // add empty cells
                    for(var ii=1;ii<=columns_to_add;ii++){
                        $('#'+tableName).children((thead==true) ? 'thead' : 'tbody').eq(childnum).children('tr').eq(line_index).children(elem).eq(col_index).after('<'+elem+'>&nbsp;</'+elem+'>');
                    }
                    line_index++;
                }
            }
            $('#'+tableName).children((thead==true) ? 'thead' : 'tbody').eq(childnum).children('tr').eq(line_index).children(elem).eq(col_index).after(line);
        }
    }while(line_start>=0 && line_index<300 && line_start<range_max);
    // remove all till end of processed section 
    var range_max=data.s.search((thead==true) ? '</thead>' : '</tbody>');
    data.s=data.s.substr(range_max+7);
}

function strip(html){
    var tmp = document.createElement("DIV");
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || "";
}

function trim(str) {
    return str.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
}

function validateAge (field, rules, i, options) {
	let date = $ (field).val () ;

    if (typeof DateFormat == 'undefined') {
        DateFormat = 0;
    }

	if (date !== NaN) {
        if (date.match (/\d{2}[^\d]\d{2}[^\d]\d{4,4}/gi) == null) {
            return rules [5];
        } else {
            var t = date.split (/[^\d]/);
            var dd = parseInt (t [(DateFormat == 0 ? 0 : 1)], 10);
            var m0 = parseInt (t [(DateFormat == 0 ? 1 : 0)], 10) - 1;  
            var yyyy = parseInt (t [2], 10);

            var d = new Date (yyyy, m0, dd); 

            if (d.getDate () != dd || d.getMonth () != m0 || d.getFullYear () != yyyy) {
                return rules [5];
            }
        }

        let years = moment ().diff (d, 'years');

		if (years < rules [3] || years > rules [4]) {
			return rules [5];
		}
	}
}

function validateAgeForSeparateFields (field, rules, i, options) {
    const fieldID = $(field).attr('id').slice(0, -1);
    const year = $('#' + fieldID + 'y').val();
    const month = $('#' + fieldID + 'm').val();
    const day = $('#' + fieldID + 'd').val();
    const date = `${year}-${month}-${day}`;

    if (!/^\d+$/.test(year)) {
        $('#' + fieldID + 'y').val('');       
            }
    if (!/^\d+$/.test(month)) {
        $('#' + fieldID + 'm').val('');        
    }
    if (!/^\d+$/.test(day)) {
        $('#' + fieldID + 'd').val('');
        }

    if (isNaN(date)) {
        return;
            }

    const ruleIndex = rules.indexOf('validateAgeForSeparateFields');
    if (ruleIndex === -1) {
        return;
        }

    const ageMin = rules[ruleIndex + 1];
    const ageMax = rules[ruleIndex + 2];
    const errorMessage = rules[ruleIndex + 3];

    if (!/^\d{4}[^\d]\d{2}[^\d]\d{2}$/.test(date)) {
        return errorMessage;
		}

    const [yyyy, mm, dd] = date.split(/[^\d]/).map(Number);
    const d = new Date(yyyy, mm - 1, dd);

    if (d.getFullYear() !== yyyy || d.getMonth() !== mm - 1 || d.getDate() !== dd) {
        return errorMessage;
        }

    const years = moment().diff(d, 'years');

    if (years < ageMin || years > ageMax) {
        return errorMessage;
    } else {
        $('#' + fieldID + 'y').closest('.tedit-editbox').find('.formError').remove();
	}
}

function validatePassword(field, rules, i, options) { 
    var passwordRegEx = new RegExp(/^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])[a-zA-Z0-9 !"@#$%&'()*+,\-./:;<=>?[\]^_`{|}~]{8,}$/);
    if(!passwordRegEx.test(field.val())){
       var text = options.allrules["dateRange"].alertText; 
       if(typeof(text) != "undefined" && text !== null )
            return text;
       else
            return '*Invalid'; 
    } 
}

var validateNumber = function (field, r, id, options)
{
     var field_name = field.attr ("name");//like field_username
     var field=field_name.replace ("field_",""); //like username
     var field_value = $("#"+field_name).val();

     if (!/^\d*$/.test (field_value)) {
         return "Only digits allowed";
     }
}
  
function insertDrillDownLines(urlToFetch,insertAfterLineID,tableName, rowID, rowCss, hide){
    // put loading sing
    $('a#'+insertAfterLineID).after('<img src="images/loader.svg" id="img'+insertAfterLineID+'">');
    $('a#'+insertAfterLineID).hide();
    $.get(urlToFetch).done(function( data ) {
        // look for table start
        var table_n = data.search(tableName);
        // remove everything before it
        data = data.substr(table_n-1);

        // build up NEW column IDs
        var tr_n = data.search('<tr');
        var tr_n_end = data.search('</tr>');
        var columns=data.substr(tr_n,tr_n_end-tr_n+5);
        // find everything inside th tags
        var cols=columns.split('</th>');
        for(var i=0;i<cols.length;i++){
            cols[i]=strip(cols[i]);
            cols[i]=trim(cols[i]);
            if(cols[i].length<=0){
                cols.splice(i,1);
                i--;
            }
        }

        // look for first tabody
        var tb_n = data.search('<tbody>');
        // remove everything before it
        data = data.substr(tb_n+6);
        // look for table end
        var tableend_n = data.search('</tbody>');
        // remove everything after it
        data = data.substr(1,tableend_n-1);

        // push the html back into original table
        // if columns count dont match- we will need to add empty cells inside the instreted data
        var tdcurentcell =  cols.length;
        var tdexistingcell =  $('#'+tableName).children('tbody').eq(0).children('tr').eq(0).children('td').length;
        if(tdcurentcell != tdexistingcell){
            // build up exiting columns list
            var origcols=$('#'+tableName).children('thead').eq(0).children('tr').eq(0).children('th');
            origcols.each(function(index){
                $(this).html(strip($(this).html()));
            });
            // proceess it line by line
            var lines=data.split('</tr>');
            for(var i=0;i<lines.length;i++){
                if(lines[i].length<=0){
                    lines.splice(i,1);
                    i--;
                }else{
                    var line=lines[i].split('</td>');
                    var index=0;
                    origcols.each(function(){

                        if(cols[index]!=this.innerText){
                            if(tdcurentcell > tdexistingcell){ 
                                line.splice(index,1)
                                index = index + 1;    
                            }else{ 
                                if(cols[index]!='') cols.splice(index,0,'');
                                line.splice(index,0,'<td>&nbsp;');
                            }
                        }
                        index++;
                    });
                    lines[i]=line.join('</td>');
                }
            }
            data=lines.join('</tr>');
        }

        if(hide == true){
            var replace_first = data.replace(/report1/g, "report1 "+rowCss+" "); 
            var replace_second = replace_first.replace(/report2/g, "report2 "+rowCss+" "); 
            $('a#'+insertAfterLineID).parent('td').parent('tr').after(replace_second);
        }else{
            $('a#'+insertAfterLineID).parent('td').parent('tr').after(data);   
        }
        $('#img'+insertAfterLineID).hide();

        if(hide == true){
            $('a#rem'+rowID).show();
        } 
    });
}

function removeDrillDownLines(rmRow, shRow){
    $( "."+rmRow ).remove();
    $('a#rem'+rmRow).hide();
    $('a#'+shRow).show();
}  

function countChar(val,min,max,chartext,fld) { 
    if(max>0){
        var len = val.value.length;
        if (len >= max) {
            val.value = val.value.substring(0, max);
            if(max-len>=0)
                $('#charNum_'+fld).text(chartext.replace('%d',max - len));
        } else {
            $('#charNum_'+fld).text(chartext.replace('%d',max - len));
        }
    }else{
        var len = val.value.length;
        $('#charNum_'+fld).text(chartext.replace('%d',len));
    }
}

function check_hex_color(field, rules, i, options){
    if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(field.val())==false) {
        // this allows the use of i18 for the error msgs
        return 'Invalid color code';
    }
}

function checkAjaxCombo(field, rules, i, options){
    if(typeof(field.val()) !== 'undefined') {
        alert('* This field is required:'+field.val());
        field.validationEngine('showPrompt', 'This filed is required', 'error');
        return '* This field is required';
    }else{
        alert('OK ?? .. field value is :'+field.val());
    }
}

function checkAjaxCombo1(field,text)
{
    var parentId = $(field).parent().attr('id');
    
    if($(field).prop('multiple'))
    {
        var comboBoxSelectedOpt = document.getElementById(field.id).selectedOptions;
        if(comboBoxSelectedOpt.length == 0)
        {
        	$('#'+parentId).validationEngine('showPrompt', text, 'error', 'topRight', true);
            status = false;
        }
        else
        {
            $('#'+parentId).validationEngine('hide');
        }
    }
    else
    {
        var comboBoxSelectedOpt = document.getElementById(field.id);
        var comboBoxSelectedOptValue = comboBoxSelectedOpt.options[comboBoxSelectedOpt.selectedIndex].value;
        if(comboBoxSelectedOptValue == 0)
        {
        	$('#'+parentId).validationEngine('showPrompt', text, 'error', 'topRight', true);
            status = false;
        }
        else
        {
            $('#'+parentId).validationEngine('hide');
        }
    }
}

var lastDayOfMonth = function (year, month) {
    return new Date((new Date(year, month, 1)) - 1).getDate ().toString().padStart (2, "0");
}

var getStartDateFromDatePeriodName = function (name) {
    var arr = name.split ('_');

    if (arr [0] == 'm') {
        return '01-' + arr [2] + '-' + arr [1];
    } else if (arr [0] == 'q') {
        switch (parseInt (arr [2])) {
            case 1: return '01-01-' + arr [1];
            case 2: return '01-04-' + arr [1];
            case 3: return '01-07-' + arr [1];
            case 4: return '01-10-' + arr [1];
        }
    } else if (arr [0] == 'y') {
        return '01-01-' + arr [1];
    }
}

var getEndDateFromDatePeriodName = function (name) {
    var arr = name.split ('_');

    if (arr [0] == 'm') {
        return lastDayOfMonth (arr [1], arr [2]) + '-' + arr [2] + '-' + arr [1];
    } else if (arr [0] == 'q') {
        switch (parseInt (arr [2])) {
            case 1: return '31-03-' + arr [1];
            case 2: return '30-06-' + arr [1];
            case 3: return '30-09-' + arr [1];
            case 4: return '31-12-' + arr [1];
        }
    } else if (arr [0] == 'y') {
        return '31-12-' + arr [1];
    }
}

var datePeriods = function () {
    var date_periods = [];

	for (year = new Date().getFullYear (); year >= 2008; year--) {
		quarters = {};

		for (quarter = 1; quarter <= 4; quarter++) {
			months = {};
			start = (quarter - 1) * 3;

			for (month = start + 1; month <= start + 3; month++) {
				month_text = month.toString ().padStart (2, '0');

				months ['m_' + year + '_' + month_text] = { 'name': month_text };
			}

			months [year + '_Quarter_Separator'] = '---------';
			months ['q_' + year + '_' + quarter] = { 'name': 'Quarter' };

			quarters [year + '_Q' + quarter] = {
				'name': 'Q' + quarter,
				'items': months
			};
		}

		quarters [year + '_Year_Separator'] = '---------';
		quarters ['y_' + year] = { 'name': 'Year' };

		date_periods.push ({
			'name': year,
			'items': quarters
		});
    }
    
    return date_periods;
}

var datePeriodsContextMenu = function (item, item_start, item_end) {
    alert (start + ' ' + end);
}

function adjustCustomField(id,value){
    let field=$('#'+id);
    let parent=field.parent();
    
    $('input',parent).remove();    
    
    let fieldValue=field.val();

    if(field.val()!=0){
        fieldValue=fieldValue.split('_');
        let customFieldId=fieldValue[0];
        let type=fieldValue[1];
        
        let input=$('<input type="text" name="'+field.attr('name')+'_'+customFieldId+'"/>');
        input.val(value);
        if(type==8){
            input.attr('type','checkbox').attr('value',1);
            input.prop('checked',value==1);
        }
        
        parent.append(input);    
    }
}
function validatePhoneField(selector, message) {
    $(selector).on('input', function () {
        var currentValue = $(this).val();
        if (!/^[0-9+]*$/.test(currentValue)) {
            $(this).val(currentValue.replace(/[^0-9+]/g, ''));
            $(this).validationEngine('showPrompt', message, 'error');
        } else {
            $(this).validationEngine('hide');
        }
    });

    $(selector).on('paste', function (e) {
        var pastedData = e.originalEvent.clipboardData.getData('text');
        if (!/^[0-9+]*$/.test(pastedData)) {
            e.preventDefault();
            $(this).validationEngine('showPrompt', message, 'error');
        }
    });
}

